#!/usr/bin/env bash

layout_uv() {
    if [[ -d ".venv" ]]; then
        VIRTUAL_ENV="$(pwd)/.venv"
    fi

    if [[ -z $VIRTUAL_ENV || ! -d $VIRTUAL_ENV ]]; then
        log_status "No virtual environment exists. Executing \`uv venv\` to create one."
        uv venv
        VIRTUAL_ENV="$(pwd)/.venv"
    fi

    PATH_add "$VIRTUAL_ENV/bin"

    export UV_ACTIVE=1  # or VENV_ACTIVE=1
    export VIRTUAL_ENV
}

use flake

layout uv
uv sync

# Load environment variables from both .env and env/.env if present
# Prefer direnv's dotenv helper for safe parsing
if has dotenv; then
  dotenv .env 2>/dev/null || true
  dotenv env/.env 2>/dev/null || true
else
  # Fallback: source if present (simple KEY=VALUE pairs)
  [ -f .env ] && source .env
  [ -f env/.env ] && source env/.env
fi